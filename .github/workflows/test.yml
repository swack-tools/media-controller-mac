name: Test

on:
  push:
    branches:
      - main
      - develop
  pull_request:

jobs:
  test:
    runs-on: warp-macos-15-arm64-6x

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Homebrew packages
        uses: WarpBuilds/cache@v1
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar/xcodegen
            /opt/homebrew/Cellar/just
          key: ${{ runner.os }}-brew-${{ hashFiles('.github/workflows/test.yml') }}
          restore-keys: |
            ${{ runner.os }}-brew-

      - name: Cache Swift PM dependencies
        uses: WarpBuilds/cache@v1
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', 'Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install dependencies
        run: |
          brew install xcodegen just

      - name: Run tests
        run: |
          just test
